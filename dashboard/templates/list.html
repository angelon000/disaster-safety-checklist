{% extends "base.html" %}

{% block title %}프로젝트 목록 - 재난·안전 체크리스트{% endblock %}

{% block extra_css %}
<style>
    .project-card {
        transition: all 0.3s ease;
        border: none;
        border-left: 4px solid var(--kcl-primary);
        height: 100%;
    }

    .project-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }

    .filter-chip {
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .filter-chip:hover {
        transform: scale(1.05);
    }

    .filter-chip.active {
        background-color: var(--kcl-primary) !important;
        color: white !important;
    }

    .view-toggle .btn {
        border-radius: 0;
    }

    .view-toggle .btn:first-child {
        border-top-left-radius: 0.25rem;
        border-bottom-left-radius: 0.25rem;
    }

    .view-toggle .btn:last-child {
        border-top-right-radius: 0.25rem;
        border-bottom-right-radius: 0.25rem;
    }

    .empty-state {
        padding: 4rem 2rem;
        text-align: center;
        color: #6c757d;
    }

    .empty-state i {
        font-size: 5rem;
        opacity: 0.3;
    }

    .project-meta {
        font-size: 0.875rem;
        color: #6c757d;
    }

    .project-actions .btn {
        opacity: 0.7;
        transition: opacity 0.2s ease;
    }

    .project-card:hover .project-actions .btn {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col-md-6">
        <h1 class="display-6 fw-bold">
            <i class="bi bi-folder-open text-primary"></i> 프로젝트 목록
        </h1>
        <p class="text-muted">생성된 체크리스트를 관리하고 확인하세요</p>
    </div>
    <div class="col-md-6 text-end">
        <a href="/" class="btn btn-primary btn-lg shadow">
            <i class="bi bi-plus-circle"></i> 새 체크리스트 생성
        </a>
    </div>
</div>

<!-- Filters & Search -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-body">
                <!-- Search Bar -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <form method="get" action="/projects" id="searchForm">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control" name="keyword"
                                       placeholder="프로젝트 이름으로 검색..."
                                       value="{{ keyword or '' }}">
                                <button class="btn btn-primary" type="submit">
                                    검색
                                </button>
                                {% if keyword %}
                                <a href="/projects" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> 초기화
                                </a>
                                {% endif %}
                            </div>
                        </form>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="btn-group view-toggle" role="group">
                            <button type="button" class="btn btn-outline-primary active" id="gridView">
                                <i class="bi bi-grid-3x3-gap"></i> 카드
                            </button>
                            <button type="button" class="btn btn-outline-primary" id="listView">
                                <i class="bi bi-list-ul"></i> 목록
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Filter Chips -->
                <div class="mb-2">
                    <small class="text-muted fw-bold d-block mb-2">
                        <i class="bi bi-funnel"></i> 시설 유형
                    </small>
                    <div class="d-flex flex-wrap gap-2" id="facilityFilters">
                        <span class="badge filter-chip bg-light text-dark" data-filter="all">
                            전체
                        </span>
                        {% for ft, count in stats.facility_types.items() %}
                        <span class="badge filter-chip bg-light text-dark" data-filter="{{ ft }}">
                            {{ ft }} ({{ count }})
                        </span>
                        {% endfor %}
                    </div>
                </div>

                <div>
                    <small class="text-muted fw-bold d-block mb-2">
                        <i class="bi bi-clipboard-check"></i> 점검 단계
                    </small>
                    <div class="d-flex flex-wrap gap-2" id="phaseFilters">
                        <span class="badge filter-chip bg-light text-dark" data-filter="all">
                            전체
                        </span>
                        {% for cp, count in stats.check_phases.items() %}
                        <span class="badge filter-chip bg-light text-dark" data-filter="{{ cp }}">
                            {{ cp }} ({{ count }})
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Projects -->
{% if projects %}
<!-- Grid View -->
<div class="row" id="projectsGrid">
    {% for project in projects %}
    <div class="col-md-6 col-lg-4 mb-4 project-item"
         data-facility="{{ project.facility_type or project.content_type }}"
         data-phase="{{ project.check_phase or project.business_stage }}">
        <div class="card project-card shadow-sm">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <h5 class="card-title fw-bold mb-0">
                        <a href="/result/{{ project.id }}" class="text-decoration-none text-dark">
                            {{ project.keyword }}
                        </a>
                    </h5>
                    <div class="project-actions">
                        <div class="btn-group btn-group-sm">
                            <a href="/result/{{ project.id }}" class="btn btn-outline-primary" title="보기">
                                <i class="bi bi-eye"></i>
                            </a>
                            <a href="/download/{{ project.id }}/markdown" class="btn btn-outline-secondary" title="다운로드">
                                <i class="bi bi-download"></i>
                            </a>
                            <button class="btn btn-outline-danger" onclick="deleteProject({{ project.id }})" title="삭제">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <span class="badge bg-primary">
                        <i class="bi bi-building"></i> {{ project.facility_type or project.content_type }}
                    </span>
                    <span class="badge bg-info">
                        <i class="bi bi-clipboard-check"></i> {{ project.check_phase or project.business_stage }}
                    </span>
                    {% if project.data_collected %}
                    <span class="badge bg-success">
                        <i class="bi bi-database-check"></i> 데이터 수집
                    </span>
                    {% endif %}
                </div>

                <div class="project-meta">
                    <i class="bi bi-calendar3"></i>
                    {{ project.created_at[:10] }}
                    <span class="mx-2">|</span>
                    <i class="bi bi-clock"></i>
                    {{ project.created_at[11:16] }}
                </div>

                {% if project.focus_area %}
                <div class="mt-2">
                    <small class="text-muted">
                        <i class="bi bi-bullseye"></i> {{ project.focus_area }}
                    </small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- List View (Hidden by default) -->
<div class="card shadow-sm" id="projectsList" style="display: none;">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th width="5%">ID</th>
                        <th width="30%">시설/사업장명</th>
                        <th width="15%">시설 유형</th>
                        <th width="15%">점검 단계</th>
                        <th width="15%">생성일시</th>
                        <th width="20%">액션</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr class="project-item"
                        data-facility="{{ project.facility_type or project.content_type }}"
                        data-phase="{{ project.check_phase or project.business_stage }}">
                        <td class="text-muted">{{ project.id }}</td>
                        <td>
                            <a href="/result/{{ project.id }}" class="text-decoration-none fw-bold">
                                {{ project.keyword }}
                            </a>
                            {% if project.data_collected %}
                            <i class="bi bi-database-check text-success ms-1" title="데이터 수집 완료"></i>
                            {% endif %}
                        </td>
                        <td>
                            <span class="badge bg-primary">
                                {{ project.facility_type or project.content_type }}
                            </span>
                        </td>
                        <td>
                            <span class="badge bg-info">
                                {{ project.check_phase or project.business_stage }}
                            </span>
                        </td>
                        <td>
                            <small class="text-muted">
                                {{ project.created_at[:16] }}
                            </small>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="/result/{{ project.id }}" class="btn btn-outline-primary" title="보기">
                                    <i class="bi bi-eye"></i>
                                </a>
                                <a href="/download/{{ project.id }}/markdown" class="btn btn-outline-secondary" title="다운로드">
                                    <i class="bi bi-download"></i>
                                </a>
                                <button class="btn btn-outline-danger" onclick="deleteProject({{ project.id }})" title="삭제">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
{% if total_pages > 1 %}
<nav aria-label="Page navigation" class="mt-4">
    <ul class="pagination justify-content-center">
        {% if page > 1 %}
        <li class="page-item">
            <a class="page-link" href="/projects?page={{ page - 1 }}{% if keyword %}&keyword={{ keyword }}{% endif %}">
                <i class="bi bi-chevron-left"></i> 이전
            </a>
        </li>
        {% endif %}

        {% for p in range(1, total_pages + 1) %}
        {% if p == page %}
        <li class="page-item active">
            <span class="page-link">{{ p }}</span>
        </li>
        {% else %}
        <li class="page-item">
            <a class="page-link" href="/projects?page={{ p }}{% if keyword %}&keyword={{ keyword }}{% endif %}">
                {{ p }}
            </a>
        </li>
        {% endif %}
        {% endfor %}

        {% if page < total_pages %}
        <li class="page-item">
            <a class="page-link" href="/projects?page={{ page + 1 }}{% if keyword %}&keyword={{ keyword }}{% endif %}">
                다음 <i class="bi bi-chevron-right"></i>
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<!-- Empty State -->
<div class="empty-state">
    <i class="bi bi-folder-x"></i>
    <h4 class="mt-3 mb-2">프로젝트가 없습니다</h4>
    <p class="text-muted mb-4">
        {% if keyword %}
        "{{ keyword }}" 검색 결과가 없습니다.
        {% else %}
        첫 번째 재난·안전 체크리스트를 생성해보세요!
        {% endif %}
    </p>
    <a href="/" class="btn btn-primary btn-lg">
        <i class="bi bi-plus-circle"></i> 새 체크리스트 생성
    </a>
</div>
{% endif %}

<!-- Stats Summary -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card bg-light border-0">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h3 class="text-primary">{{ stats.total_projects }}</h3>
                        <small class="text-muted">전체 프로젝트</small>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-success">{{ stats.facility_types|length }}</h3>
                        <small class="text-muted">시설 유형</small>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-info">{{ stats.check_phases|length }}</h3>
                        <small class="text-muted">점검 단계</small>
                    </div>
                    <div class="col-md-3">
                        <h3 class="text-warning">{{ stats.recent_7days }}</h3>
                        <small class="text-muted">최근 7일</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// 삭제 함수
async function deleteProject(projectId) {
    if (!confirm('정말 삭제하시겠습니까?')) {
        return;
    }

    try {
        const response = await fetch(`/api/projects/${projectId}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            alert('삭제되었습니다.');
            location.reload();
        } else {
            alert('삭제 실패: ' + result.error);
        }
    } catch (error) {
        alert('오류 발생: ' + error.message);
    }
}

// 뷰 전환
const gridView = document.getElementById('gridView');
const listView = document.getElementById('listView');
const projectsGrid = document.getElementById('projectsGrid');
const projectsList = document.getElementById('projectsList');

gridView.addEventListener('click', () => {
    gridView.classList.add('active');
    listView.classList.remove('active');
    projectsGrid.style.display = 'flex';
    projectsGrid.style.flexWrap = 'wrap';
    projectsList.style.display = 'none';
    localStorage.setItem('projectView', 'grid');
});

listView.addEventListener('click', () => {
    listView.classList.add('active');
    gridView.classList.remove('active');
    projectsGrid.style.display = 'none';
    projectsList.style.display = 'block';
    localStorage.setItem('projectView', 'list');
});

// 저장된 뷰 설정 불러오기
const savedView = localStorage.getItem('projectView') || 'grid';
if (savedView === 'list') {
    listView.click();
}

// 필터링 기능
const facilityFilters = document.querySelectorAll('#facilityFilters .filter-chip');
const phaseFilters = document.querySelectorAll('#phaseFilters .filter-chip');
let activeFilters = { facility: 'all', phase: 'all' };

facilityFilters.forEach(chip => {
    chip.addEventListener('click', () => {
        facilityFilters.forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        activeFilters.facility = chip.dataset.filter;
        applyFilters();
    });
});

phaseFilters.forEach(chip => {
    chip.addEventListener('click', () => {
        phaseFilters.forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        activeFilters.phase = chip.dataset.filter;
        applyFilters();
    });
});

function applyFilters() {
    const projectItems = document.querySelectorAll('.project-item');

    projectItems.forEach(item => {
        const facility = item.dataset.facility;
        const phase = item.dataset.phase;

        const matchFacility = activeFilters.facility === 'all' || facility === activeFilters.facility;
        const matchPhase = activeFilters.phase === 'all' || phase === activeFilters.phase;

        if (matchFacility && matchPhase) {
            item.style.display = '';
        } else {
            item.style.display = 'none';
        }
    });
}

// 기본 필터 활성화
document.querySelector('#facilityFilters .filter-chip[data-filter="all"]').classList.add('active');
document.querySelector('#phaseFilters .filter-chip[data-filter="all"]').classList.add('active');
</script>
{% endblock %}
